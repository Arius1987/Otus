## Третья лабораторная работа.

В ней я изначально хотел собрать что-то похожее на clos: proxmox расставить как спайны, коммутаторы arista - лифами (route reflectors) . Но не судьба - ибо underlay наш работает на статических маршрутах. Вся проблематика описана в лабе номер 2.
Но что делать, если не какую-то отказоусочивость и балансировку получить все-таки очень хочется, а underlay нам рисует индейские националые избы? Не забудем, что под капотом proxmox крутится всемогущий Linux котрый может решить проблему встронными средствами операционной системы. 

Ко второй лабе в добавим еще 1 роутер. Получим такую схему:

![image](https://github.com/user-attachments/assets/149dd703-79d8-4e63-a9b8-39f8dda3851c)

Настою ip адресацию:

![image](https://github.com/user-attachments/assets/a8e1c51b-70bc-4e2c-9cfe-df47b40c32f1)

Жмем ok, потом apply

Не забудем статические маршруты:

![image](https://github.com/user-attachments/assets/9720b78e-d3e0-435d-832b-233acd9b5088)

Рестартанем сервис сети:

systemctl restart networking.service

Аналогично на втором проксмоксе, и все мы знаем, как настраивать базовый конфиг на cisco ios (там настроена обычная маршрутизация между 10.3.0.0/24 и 10.2.0.0/24)

Отключим проверку обратных маршрутов в /etc/sysctl.conf, чтоб пакет прилетевший условно на ens4, мог уйти обратно через ens5:

net.ipv4.conf.all.rp_filter = 0

net.ipv4.conf.default.rp_filter = 0

Отвяжем маршрут по умолчанию от моего домашнего роутера

ip route add 192.168.5.0/27 via 192.168.5.1

ip route del default

Применим данные настройки:

sysctl -p

Создадим скрипт для балансировки нагрузки:

 nano /usr/local/bin/script.sh


#!/bin/bash

\# создание таблиц
echo 200 r5 >> /etc/iproute2/rt_tables
echo 201 r10 >> /etc/iproute2/rt_tables

\# пакеты с ip.src 10.1.0.1 кладем в таблицу r5, а 10.3.0.1 в r10

ip rule add from 10.1.0.1 table r5
ip rule add from 10.3.0.1 table r10

\# два дефолтных маршрута для пакетов, попадающих под правила таблиц r5 и r10

ip route add default via 10.0.0.2 table r5
ip route add default via 10.2.0.2 table r10

\# к обоим маршрутам вешаем default gateway и одинаковую метрику

ip route add default scope global nexthop via 10.0.0.2 dev ens4 weight 2 nexthop via 10.2.0.2 dev ens5 weight 2

Боюсь на этом все. Но нужно еще прикрутить скрипт отслеживающий пинги к удаленным гипервизозорам, и если пингов не будет - соответсвующий маршрут будет удален. 
За основу можно взять скипты отсюда:

https://help.ubuntu.ru/wiki/ip_balancing

или отсюда:

https://web.archive.org/web/20160807025250/https://habrahabr.ru/post/54748/










